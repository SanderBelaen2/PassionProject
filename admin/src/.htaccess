RewriteEngine on

RewriteCond %{THE_REQUEST} ^GET.*index\.php [NC]
RewriteRule (.*?)index\.php/*(.*) /$1$2 [R=301,NE,L]

RewriteRule ^([^/.]+)$ index.php?page=$1
RewriteRule ^([^/.]+)$ index.php?url=$1

RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [L,R] # <- for test, for prod use [L,R=301]

RewriteRule ^settings/([a-z]+)$ ?page=settings&setting=$1 [NC,L]
RewriteRule ^blogpost/([0-9]+)$ ?page=blogpost&id=$1 [NC,L]
RewriteRule ^analytics/([a-z]+)$ ?page=analytics&period=$1 [NC,L]
RewriteRule ^p/([A-Za-z0-9-]+)$ ?page=p&url=$1 [NC,L]

RewriteCond %{REQUEST_URI} !/
RewriteRule (.*) /$1 [L]

ExpiresActive On
ExpiresDefault A0

<FilesMatch "\.(gif|jpg|jpeg|png|GIF|JPG|JPEG|PNG)$">
  ExpiresDefault A2592000
  Header append Cache-Control "public"
</FilesMatch>

<FilesMatch "\.(less|js|css|gz)$">
  ExpiresDefault A2592000
  Header append Cache-Control "proxy-revalidate"
</FilesMatch>

<FilesMatch "\.(php)$">
  ExpiresActive Off
  Header set Cache-Control "private, no-cache, no-store, proxy-revalidate, no-transform"
  Header set Pragma "no-cache"
</FilesMatch>

<IfModule mod_headers.c>
  <FilesMatch "\.(less|js|css|xml|gz)$">
    Header append Vary Accept-Encoding
  </FilesMatch>
</IfModule>

# compress text, HTML, JavaScript, CSS, and XML
AddOutputFilterByType DEFLATE text/plain
AddOutputFilterByType DEFLATE text/html
AddOutputFilterByType DEFLATE text/xml
AddOutputFilterByType DEFLATE text/css
AddOutputFilterByType DEFLATE application/xml
AddOutputFilterByType DEFLATE application/xhtml+xml
AddOutputFilterByType DEFLATE application/rss+xml
AddOutputFilterByType DEFLATE application/javascript
AddOutputFilterByType DEFLATE application/x-javascript
AddOutputFilterByType DEFLATE font/woff .woff
AddOutputFilterByType DEFLATE application/x-font-woff
AddOutputFilterByType DEFLATE application/font-woff
AddOutputFilterByType DEFLATE image/svg+xml
AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
AddOutputFilterByType DEFLATE application/x-font-otf
AddType application/x-font-woff .woff
ExpiresByType application/x-font-woff "access plus 1 year"

# remove browser bugs
BrowserMatch ^Mozilla/4 gzip-only-text/html
BrowserMatch ^Mozilla/4\.0[678] no-gzip
BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
